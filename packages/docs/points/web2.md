# Web2 components and flow

## Backend Architecture for the Superchain Points System

This document outlines the architecture and functionality of the backend required to implement the Superchain Points System, including the handling of user accounts, event processing, and points mapping.

### Please note:

**Future adjustments might be necessary to streamline its functionality within the system.**

---

## **Architecture Overview**

The backend is built to manage user accounts, process events, and handle the logic for mapping events to points. It relies on **AWS** for scalability and event-driven operations.

[← Docs Overview](../research.md#points-strategy)

---

## **Key Components**

### 1. **User Accounts Management**
This component handles the creation and registration of new user accounts and tracks events attached to timeframes.

- **Endpoint**: `POST /accounts`
  - **Purpose**: Registers a new user account in the system.
  - **Flow**:
    1. Stores the user data in **DB**.
    2. For timeframe-based events, adds a record with a **TTL (Time-to-Live)** attribute.
    3. **DynamoDB Stream** triggers a **Lambda function** to process the event upon TTL expiration.

---

### 2. **Event Listener**

[← Listeners](../research.md#listeners)

The `op-superchain-events-listener` module is responsible for listening to blockchain events, normalizing these events, and sending them to the backend for processing. It ensures that all relevant events are captured and forwarded to the backend, where they are validated, mapped to points, and stored in the user accounts. This module acts as the bridge between the blockchain and the backend system, enabling real-time event tracking and points allocation.

### 3. **Event Processing**
Handles the processing of events generated by a pre-existing event listener module.

- **Endpoint**: `POST /events`
  - **Purpose**: Processes incoming events and updates the corresponding user's points.
  - **Payload**:
    ```json
    {
      "userId": "string",
      "event": "string",
      "timestamp": "ISO_8601_string",
      "metadata": { "key": "value" }
    }
    ```
  - **Flow**:
    1. Validates the event against the **event-to-points mapping**.
    2. Updates the user's points balance in **DB**.
    3. Emits logs/metrics for monitoring.

---

### 4. **Event-to-Points Mapping Management**
Allows administrators to define or update the mapping between events and the points they award.

- **Endpoint**: `PUT /events/mapping`
  - **Purpose**: Creates or updates the mapping of events to points.
  - **Payload**:
    ```json
    {
      "eventName": "string",
      "points": "number",
      "frequency": "string"
    }
    ```
  - **Flow**:
    1. Stores the mapping in a dedicated **DB** table.
    2. Updates any in-memory cache for faster lookups during event processing.

---
## **Event Processing Workflow**

### **Timeframe-Based Events**
1. When a timeframe-based event is created, a record with a TTL is stored in the **User Accounts Table**.
2. Upon TTL expiration, triggers a **Lambda function** to:
   - Validate the event.
   - Update the user's points balance.

### **General Event Processing**
1. Events are sent to the `POST /events` endpoint by the listener module.
2. The endpoint:
   - Validates the event.
   - Checks the points mapping in the **Event Mapping Table**.
   - Updates the user's points balance in the **User Accounts Table**.

---

## **Security and Scalability**

1. **Authentication**: All endpoints are secured with API Gateway
2. **Rate Limiting**: API Gateway throttling ensures fair usage and prevents abuse.
3. **Scalability**:
   - **Lambda functions** for event-driven operations.
   - **CloudWatch** for monitoring and logging.

---

## **Monitoring and Observability**

- **Metrics**:
  - Total events processed.
  - Points awarded per event type.
  - TTL expirations processed.
- **Dashboards**: CloudWatch dashboards for real-time visibility.
- **Alerts**: Set up alerts for anomalies or failures (e.g., Lambda errors, high latency).

---

## **Future Enhancements**

1. **Sybil Detection**: Implement mechanisms to prevent abuse (e.g., bot accounts).
2. **Cache Layer**: Add a caching layer (e.g., Redis) for faster lookups of event mappings.
3. **Extensibility**: Support new event types and reward systems without disrupting existing functionality.

---